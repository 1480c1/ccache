srcdir = @srcdir@
VPATH = @srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
datarootdir = @datarootdir@
installcmd = @INSTALL@

CC = @CC@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@ -MD -MP -I.
LDFLAGS = @LDFLAGS@
EXEEXT = @EXEEXT@

libs = @LIBS@ -lm

sources = \
    ccache.c mdfour.c hash.c execute.c util.c args.c stats.c \
    cleanup.c snprintf.c unify.c manifest.c hashtable.c hashtable_itr.c \
    murmurhashneutral2.c hashutil.c

headers = \
    ccache.h hashtable.h hashtable_itr.h hashtable_private.h hashutil.h \
    manifest.h mdfour.h murmurhashneutral2.h

objs = $(sources:.c=.o)

dist_files = \
    $(sources) $(headers) configure Makefile.in config.h.in ccache.1 \
    test.sh install-sh README COPYING

version := $(shell sed -n 's/^\#define CCACHE_VERSION "\(.*\)"/\1/p' ccache.h)
dist_dir := ccache-$(version)
dist_archive_tar_bz2 := ccache-$(version).tar.bz2
dist_archive_tar_gz := ccache-$(version).tar.gz

all: ccache$(EXEEXT)

docs: ccache.1 #web/ccache-man.html

ccache$(EXEEXT): $(objs)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(objs) $(libs)

ccache.1: ccache.yo
	yodl2man -o ccache.1 ccache.yo

#web/ccache-man.html: ccache.yo
#	yodl2html -o web/ccache-man.html ccache.yo

install: all
	$(installcmd) -d $(DESTDIR)$(bindir)
	$(installcmd) -s -m 755 ccache$(EXEEXT) $(DESTDIR)$(bindir)
	$(installcmd) -d $(DESTDIR)$(mandir)/man1
	$(installcmd) -m 644 $(srcdir)/ccache.1 $(DESTDIR)$(mandir)/man1/

dist: $(dist_archive_tar_bz2) $(dist_archive_tar_gz)

$(dist_archive_tar_bz2): $(dist_files)
	tmpdir=$$(mktemp -d) && \
	dir=$$tmpdir/$(dist_dir) && \
	mkdir $$dir && \
	cp $(dist_files) $$dir && \
	(cd $$tmpdir && \
	 tar cjf $(CURDIR)/$(dist_archive_tar_bz2) $(dist_dir)) && \
	rm -rf $$tmpdir

$(dist_archive_tar_gz): $(dist_files)
	tmpdir=$$(mktemp -d) && \
	dir=$$tmpdir/$(dist_dir) && \
	mkdir $$dir && \
	cp $(dist_files) $$dir && \
	(cd $$tmpdir && \
	 tar czf $(CURDIR)/$(dist_archive_tar_gz) $(dist_dir)) && \
	rm -rf $$tmpdir

clean:
	rm -f $(objs) *~ ccache$(EXEEXT) *.d ccache.1 web/ccache-man.html \
	      $(dist_archive_tar_bz2) $(dist_archive_tar_gz)

test: test.sh
	CC='$(CC)' ./test.sh

check: test

distclean: clean
	rm -f Makefile config.h config.log config.status

installcheck:
	CCACHE=$(bindir)/ccache ./test.sh

check-syntax:
	$(CC) $(filter-out -M%, $(CPPFLAGS)) $(CFLAGS) -S -o /dev/null $(CHK_SOURCES)

-include $(sources:.c=.d)
