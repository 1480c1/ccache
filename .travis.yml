language: c
dist: xenial

script:
  - ./autogen.sh
  - ./configure $CONFIGURE
  - make
  - make ${TEST:-test}

matrix:
  include:

  # Job 1:
  - os: linux
    compiler: gcc
    env: V=1
    addons:
      apt:
        packages:
        - elfutils
        - gperf
        - libzstd1-dev

  # Job 2:
  - os: linux
    compiler: clang
    env: V=1
    addons:
      apt:
        packages:
        - elfutils
        - gperf
        - libzstd1-dev

  # Job 3:
  - os: osx
    compiler: clang
    env: V=1 CONFIGURE="--with-libzstd-from-internet"

  # Job 4:
  - os: linux
    compiler: gcc
    env: V=1 CFLAGS="-m32 -g -O2" LDFLAGS="-m32" CONFIGURE="--host=i386-linux-gnu --with-libzstd-from-internet"
    addons:
      apt:
        packages:
        - gcc-multilib
        - gperf

  # Job 5:
  - os: linux
    compiler: i686-w64-mingw32-gcc
    env: V=1 CONFIGURE="--host=i686-w64-mingw32 --with-libzstd-from-internet" TEST="unittest/run.exe"
    addons:
      apt:
        packages:
        - elfutils
        - gperf

  # Job 6:
  - os: linux
    compiler: clang
    env: V=1 CFLAGS="-fsanitize=undefined" LDFLAGS="-fsanitize=undefined" ASAN_OPTIONS="detect_leaks=0"
    addons:
      apt:
        packages:
        - elfutils
        - gperf
        - libzstd1-dev

  # Job 7:
  - os: linux
    compiler: clang
    env: V=1 CFLAGS="-fsanitize=address -g" LDFLAGS="-fsanitize=address" ASAN_OPTIONS="detect_leaks=0"
    addons:
      apt:
        packages:
        - elfutils
        - gperf
        - libzstd1-dev

  # Job 8:
  - os: linux
    compiler: clang
    env: V=1 PATH="/usr/bin:$PATH" TEST=analyze
    addons:
      apt:
        packages:
        - clang  # for scan-build
        - gperf
        - libzstd1-dev

  # Job 9:
  - os: linux
    compiler: gcc
    env: V=1 CUDA=8.0.61-1
    sudo: required
    addons:
      apt:
        packages:
        - elfutils
        - gperf
        - libzstd1-dev
    before_install:
    - source ./.travis/install_cuda.sh
